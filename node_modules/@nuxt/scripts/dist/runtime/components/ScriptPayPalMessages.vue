<script setup>
import { computed, onMounted, ref, shallowRef, watch } from "vue";
import { defu } from "defu";
import { useScriptPayPal } from "../registry/paypal";
import { useScriptTriggerElement } from "../composables/useScriptTriggerElement";
import { onBeforeUnmount, resolveComponent } from "vue";
const el = ref(null);
const rootEl = ref(null);
const props = defineProps({
  rootAttrs: { type: Object, required: false },
  trigger: { type: [String, Array, Boolean], required: false, default: "visible" },
  clientId: { type: String, required: false, default: "test" },
  messagesOptions: { type: Object, required: false, default: () => ({}) },
  merchantId: { type: String, required: false },
  partnerAttributionId: { type: String, required: false },
  paypalScriptOptions: { type: Object, required: false, default: () => ({}) }
});
const ready = ref(false);
const { onLoaded, status } = useScriptPayPal({
  clientId: props.clientId,
  merchantId: props.merchantId,
  partnerAttributionId: props.partnerAttributionId,
  ...props.paypalScriptOptions
});
const emit = defineEmits(["apply", "clickMessages", "render"]);
const options = computed(() => {
  const _options = {
    onApply: (data) => {
      emit("apply", data);
      return props.messagesOptions?.onApply?.(data);
    },
    onClick: (data) => {
      emit("clickMessages", data);
      return props.messagesOptions?.onClick?.(data);
    },
    onRender: (data) => {
      emit("render", data);
      return props.messagesOptions?.onRender?.(data);
    }
  };
  return defu(_options, props.messagesOptions);
});
const messageInst = shallowRef();
onMounted(() => {
  onLoaded(async ({ paypal }) => {
    if (!el.value) return;
    messageInst.value = paypal?.Messages?.(options.value);
    await messageInst.value?.render(el.value);
    ready.value = true;
    watch(() => options.value, async (_options) => {
      if (!el.value) return;
      messageInst.value = paypal?.Messages?.(_options);
      await messageInst.value?.render(el.value);
    });
  });
});
function destroy() {
  if (!el.value) return;
  el.value?.replaceChildren();
}
onBeforeUnmount(() => {
  destroy();
});
const ScriptLoadingIndicator = resolveComponent("ScriptLoadingIndicator");
const trigger = useScriptTriggerElement({ trigger: props.trigger, el: rootEl });
const rootAttrs = computed(() => {
  return defu(props.rootAttrs, {
    "aria-busy": status.value === "loading",
    "aria-label": status.value === "awaitingLoad" ? "PayPal Script Placeholder" : status.value === "loading" ? "PayPal Buttons Loading" : "PayPal Buttons",
    "aria-live": "polite",
    "role": "application",
    ...trigger instanceof Promise ? trigger.ssrAttrs || {} : {}
  });
});
</script>

<template>
  <div v-bind="rootAttrs" id="test">
    <div v-show="ready" ref="el" />
    <slot v-if="!ready" name="placeholder">
      placeholder
    </slot>
    <slot v-if="status !== 'awaitingLoad' && !ready" name="loading">
      <ScriptLoadingIndicator color="black" />
    </slot>
    <slot v-if="status === 'awaitingLoad'" name="awaitingLoad" />
    <slot v-else-if="status === 'error'" name="error" />
    <slot />
  </div>
</template>
