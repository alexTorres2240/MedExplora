<script setup>
import { computed, onMounted, ref, shallowRef, watch } from "vue";
import { defu } from "defu";
import { useScriptPayPal } from "../registry/paypal";
import { useScriptTriggerElement } from "../composables/useScriptTriggerElement";
import { onBeforeUnmount, resolveComponent } from "vue";
const el = ref(null);
const rootEl = ref(null);
const props = defineProps({
  rootAttrs: { type: Object, required: false },
  trigger: { type: [String, Array, Boolean], required: false, default: "visible" },
  clientId: { type: String, required: false, default: "test" },
  marksOptions: { type: Object, required: false, default: () => ({}) },
  paypalScriptOptions: { type: Object, required: false, default: () => ({}) }
});
const ready = ref(false);
const { onLoaded, status } = useScriptPayPal({
  clientId: props.clientId,
  ...props.paypalScriptOptions
});
const marksInst = shallowRef();
onMounted(() => {
  onLoaded(async ({ paypal }) => {
    if (!el.value) return;
    marksInst.value = paypal?.Marks?.(props.marksOptions);
    await marksInst.value?.render(el.value);
    ready.value = true;
    watch(() => props.marksOptions, async (_options) => {
      if (!el.value) return;
      destroy();
      marksInst.value = paypal?.Marks?.(_options);
      await marksInst.value?.render(el.value);
    });
  });
});
function destroy() {
  if (!el.value) return;
  el.value?.replaceChildren();
}
onBeforeUnmount(() => {
  destroy();
});
const ScriptLoadingIndicator = resolveComponent("ScriptLoadingIndicator");
const trigger = useScriptTriggerElement({ trigger: props.trigger, el: rootEl });
const rootAttrs = computed(() => {
  return defu(props.rootAttrs, {
    "aria-busy": status.value === "loading",
    "aria-label": status.value === "awaitingLoad" ? "PayPal Script Placeholder" : status.value === "loading" ? "PayPal Marks Loading" : "PayPal Marks",
    "aria-live": "polite",
    "role": "application",
    ...trigger instanceof Promise ? trigger.ssrAttrs || {} : {}
  });
});
</script>

<template>
  <div v-bind="rootAttrs" id="test">
    <div v-show="ready" ref="el" />
    <slot v-if="!ready" name="placeholder">
      placeholder
    </slot>
    <slot v-if="status !== 'awaitingLoad' && !ready" name="loading">
      <ScriptLoadingIndicator color="black" />
    </slot>
    <slot v-if="status === 'awaitingLoad'" name="awaitingLoad" />
    <slot v-else-if="status === 'error'" name="error" />
    <slot />
  </div>
</template>
