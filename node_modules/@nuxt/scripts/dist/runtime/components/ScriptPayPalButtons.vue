<script setup>
import { computed, onMounted, ref, shallowRef, watch } from "vue";
import { defu } from "defu";
import { useScriptPayPal } from "../registry/paypal";
import { useScriptTriggerElement } from "../composables/useScriptTriggerElement";
import { onBeforeUnmount, resolveComponent } from "vue";
const el = ref(null);
const rootEl = ref(null);
const props = defineProps({
  rootAttrs: { type: Object, required: false },
  trigger: { type: [String, Array, Boolean], required: false, default: "visible" },
  clientId: { type: String, required: false, default: "test" },
  buttonOptions: { type: Object, required: false, default: () => ({}) },
  paypalScriptOptions: { type: Object, required: false, default: () => ({}) },
  disabled: { type: Boolean, required: false, default: false }
});
const ready = ref(false);
const { onLoaded, status } = useScriptPayPal({
  clientId: props.clientId,
  ...props.paypalScriptOptions
});
const emit = defineEmits(["approve", "error", "cancel", "clickButtons", "shippingOptionsChange", "shippingAddressChange", "init"]);
const initActions = shallowRef(null);
const handleDisabled = () => {
  if (!initActions.value) return;
  if (props.disabled) {
    initActions.value.disable();
  } else {
    initActions.value.enable();
  }
};
const options = computed(() => {
  const _options = {
    onApprove: async (data, actions) => {
      emit("approve", data, actions);
      return props.buttonOptions?.onApprove?.(data, actions);
    },
    onError: (err) => {
      emit("error", err);
      return props.buttonOptions?.onError?.(err);
    },
    onCancel: (data, actions) => {
      emit("cancel", data, actions);
      return props.buttonOptions?.onCancel?.(data, actions);
    },
    onClick: (data, actions) => {
      emit("clickButtons", data, actions);
      return props.buttonOptions?.onClick?.(data, actions);
    },
    onShippingOptionsChange: async (data, actions) => {
      emit("shippingOptionsChange", data, actions);
      return props.buttonOptions?.onShippingOptionsChange?.(data, actions);
    },
    onShippingAddressChange: async (data, actions) => {
      emit("shippingAddressChange", data, actions);
      return props.buttonOptions?.onShippingAddressChange?.(data, actions);
    },
    onInit: (data, actions) => {
      initActions.value = actions;
      actions.disable();
      handleDisabled();
      emit("init", data, actions);
      return props.buttonOptions?.onInit?.(data, actions);
    }
  };
  return defu(_options, props.buttonOptions);
});
watch(() => props.disabled, handleDisabled);
const buttonInst = shallowRef();
onMounted(() => {
  onLoaded(async ({ paypal }) => {
    if (!el.value) return;
    buttonInst.value = paypal?.Buttons?.(options.value);
    await buttonInst.value?.render(el.value);
    ready.value = true;
    watch(() => options.value, async (_options) => {
      if (!el.value) return;
      await buttonInst.value?.updateProps(_options);
    });
  });
});
async function destroy() {
  if (buttonInst.value) {
    await buttonInst.value?.close();
  }
}
onBeforeUnmount(async () => {
  await destroy();
});
const ScriptLoadingIndicator = resolveComponent("ScriptLoadingIndicator");
const trigger = useScriptTriggerElement({ trigger: props.trigger, el: rootEl });
const rootAttrs = computed(() => {
  return defu(props.rootAttrs, {
    "aria-busy": status.value === "loading",
    "aria-label": status.value === "awaitingLoad" ? "PayPal Script Placeholder" : status.value === "loading" ? "PayPal Buttons Loading" : "PayPal Buttons",
    "aria-live": "polite",
    "role": "application",
    ...trigger instanceof Promise ? trigger.ssrAttrs || {} : {}
  });
});
</script>

<template>
  <div v-bind="rootAttrs" id="test">
    <div v-show="ready" ref="el" />
    <slot v-if="!ready" name="placeholder">
      placeholder
    </slot>
    <slot v-if="status !== 'awaitingLoad' && !ready" name="loading">
      <ScriptLoadingIndicator color="black" />
    </slot>
    <slot v-if="status === 'awaitingLoad'" name="awaitingLoad" />
    <slot v-else-if="status === 'error'" name="error" />
    <slot />
  </div>
</template>
