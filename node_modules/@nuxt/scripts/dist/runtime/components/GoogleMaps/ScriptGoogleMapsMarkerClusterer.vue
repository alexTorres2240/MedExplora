<template>
  <slot v-if="markerClusterer" />
</template>

<script>
import { MarkerClusterer } from "@googlemaps/markerclusterer";
import { inject, onUnmounted, provide, shallowRef } from "vue";
import { whenever } from "@vueuse/core";
import { MAP_INJECTION_KEY } from "./ScriptGoogleMaps.vue";
export const MARKER_CLUSTERER_INJECTION_KEY = Symbol("marker-clusterer");
</script>

<script setup>
const props = defineProps({
  options: { type: Object, required: false }
});
const markerClustererEvents = [
  "click",
  "clusteringbegin",
  "clusteringend"
];
const emit = defineEmits([]);
const mapContext = inject(MAP_INJECTION_KEY, void 0);
const markerClusterer = shallowRef(void 0);
whenever(() => mapContext?.map.value, (map) => {
  markerClusterer.value = new MarkerClusterer({
    map,
    ...props.options
  });
  setupMarkerClustererEventListeners(markerClusterer.value);
}, {
  immediate: true,
  once: true
});
const markerClustererNeedsRerender = shallowRef(false);
function requestRerender() {
  markerClustererNeedsRerender.value = true;
}
whenever(() => markerClustererNeedsRerender.value && markerClusterer.value, () => {
  markerClusterer.value.render();
  markerClustererNeedsRerender.value = false;
});
onUnmounted(() => {
  if (!markerClusterer.value || !mapContext?.mapsApi.value) {
    return;
  }
  mapContext.mapsApi.value.event.clearInstanceListeners(markerClusterer.value);
  markerClusterer.value.setMap(null);
});
provide(
  MARKER_CLUSTERER_INJECTION_KEY,
  {
    markerClusterer,
    requestRerender
  }
);
function setupMarkerClustererEventListeners(markerClusterer2) {
  markerClustererEvents.forEach((event) => {
    markerClusterer2.addListener(event, () => emit(event, markerClusterer2));
  });
}
</script>
