<template>
  <slot v-if="advancedMarkerElement" />
</template>

<script>
import { inject, onUnmounted, provide, shallowRef } from "vue";
import { whenever } from "@vueuse/core";
import { MAP_INJECTION_KEY } from "./ScriptGoogleMaps.vue";
import { MARKER_CLUSTERER_INJECTION_KEY } from "./ScriptGoogleMapsMarkerClusterer.vue";
export const ADVANCED_MARKER_ELEMENT_INJECTION_KEY = Symbol("marker");
</script>

<script setup>
const props = defineProps({
  options: { type: Object, required: false }
});
const eventsWithoutPayload = [
  "animation_changed",
  "clickable_changed",
  "cursor_changed",
  "draggable_changed",
  "flat_changed",
  "icon_changed",
  "position_changed",
  "shape_changed",
  "title_changed",
  "visible_changed",
  "zindex_changed"
];
const eventsWithMapMouseEventPayload = [
  "click",
  "contextmenu",
  "dblclick",
  "drag",
  "dragend",
  "dragstart",
  "mousedown",
  "mouseout",
  "mouseover",
  "mouseup"
];
const emit = defineEmits([]);
const mapContext = inject(MAP_INJECTION_KEY, void 0);
const markerClustererContext = inject(MARKER_CLUSTERER_INJECTION_KEY, void 0);
const advancedMarkerElement = shallowRef(void 0);
whenever(() => mapContext?.map.value && mapContext.mapsApi.value, async () => {
  await mapContext.mapsApi.value.importLibrary("marker");
  advancedMarkerElement.value = new mapContext.mapsApi.value.marker.AdvancedMarkerElement(props.options);
  setupAdvancedMarkerElementEventListeners(advancedMarkerElement.value);
  if (markerClustererContext?.markerClusterer.value) {
    markerClustererContext.markerClusterer.value.addMarker(advancedMarkerElement.value);
  } else {
    advancedMarkerElement.value.map = mapContext.map.value;
  }
  whenever(() => props.options, (options) => {
    if (advancedMarkerElement.value && options) {
      Object.assign(advancedMarkerElement.value, options);
    }
  }, {
    deep: true
  });
}, {
  immediate: true,
  once: true
});
onUnmounted(() => {
  if (!advancedMarkerElement.value || !mapContext?.mapsApi.value) {
    return;
  }
  mapContext.mapsApi.value.event.clearInstanceListeners(advancedMarkerElement.value);
  if (markerClustererContext) {
    markerClustererContext.markerClusterer.value?.removeMarker(advancedMarkerElement.value);
  } else {
    advancedMarkerElement.value.map = null;
  }
});
provide(ADVANCED_MARKER_ELEMENT_INJECTION_KEY, { advancedMarkerElement });
function setupAdvancedMarkerElementEventListeners(advancedMarkerElement2) {
  eventsWithoutPayload.forEach((event) => {
    advancedMarkerElement2.addListener(event, () => emit(event));
  });
  eventsWithMapMouseEventPayload.forEach((event) => {
    advancedMarkerElement2.addListener(event, (payload) => emit(event, payload));
  });
}
</script>
